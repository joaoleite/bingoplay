<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Display do Bingo</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="display-page">
    <div class="display-container">
        <div id="currentDisplay" class="current-number-display">
            <div class="waiting-message">
                <h1>ðŸŽ¯ BINGO</h1>
                <p>Aguardando prÃ³ximo nÃºmero...</p>
            </div>
        </div>
        
        <!-- Ãšltimos nÃºmeros sorteados -->
        <div id="recentNumbers" class="recent-numbers">
            <h3>Ãšltimos nÃºmeros sorteados:</h3>
            <div id="recentNumbersList" class="recent-numbers-list"></div>
        </div>
        
        <div id="allNumbersDisplay" class="all-numbers-display" style="display: none;">
            <h2>NÃºmeros Sorteados</h2>
            <div id="allNumbersGrid" class="all-numbers-grid"></div>
        </div>
        
        <!-- Controle de Wake Lock -->
        <div id="wakeLockControl" class="wake-lock-control">
            <button id="wakeLockBtn" class="wake-lock-btn">ðŸ”’ Manter Tela Ativa</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="nosleep.js"></script>
    <script>
        const socket = io();
        
        // FunÃ§Ã£o para formatar nÃºmeros com zero Ã  esquerda
        function formatNumber(number) {
            return number.toString().padStart(2, '0');
        }
        
        const currentDisplay = document.getElementById('currentDisplay');
        const allNumbersDisplay = document.getElementById('allNumbersDisplay');
        const allNumbersGrid = document.getElementById('allNumbersGrid');
        const recentNumbers = document.getElementById('recentNumbers');
        const recentNumbersList = document.getElementById('recentNumbersList');
        
        // Inicializar NoSleep
        const noSleep = new NoSleep();
        let wakeLockEnabled = false;
        const wakeLockBtn = document.getElementById('wakeLockBtn');
        const wakeLockControl = document.getElementById('wakeLockControl');
        let hideButtonTimeout;
        
        // Socket events
        socket.on('gameState', (state) => {
            if (state.isShowingAll && state.drawnNumbers.length > 0) {
                showAllNumbers(state.drawnNumbers);
            } else if (state.currentNumber) {
                showCurrentNumber(state.currentNumber);
            } else {
                showWaitingMessage();
            }
            updateRecentNumbers(state.drawnNumbers);
        });
        
                socket.on('numberDrawn', (data) => {
            showCurrentNumber(data.number);
            updateRecentNumbers(data.drawnNumbers);
        });
        
        socket.on('showLast', (data) => {
            if (data.number) {
                showCurrentNumber(data.number);
                updateRecentNumbers(data.drawnNumbers);
            } else {
                showWaitingMessage();
                updateRecentNumbers(data.drawnNumbers);
            }
        });

        socket.on('showAll', (data) => {
            showAllNumbers(data.numbers);
        });
        
        socket.on('gameReset', () => {
            showWaitingMessage();
            updateRecentNumbers([]);
        });
        
        // Functions
        function showCurrentNumber(number) {
            allNumbersDisplay.style.display = 'none';
            currentDisplay.style.display = 'flex';
            recentNumbers.style.display = 'block';
            
            const bingoLetter = getBingoLetter(number);
            currentDisplay.innerHTML = `
                <div class="number-display ${bingoLetter.toLowerCase()}">
                    <div class="letter">${bingoLetter}</div>
                    <span class="number">${formatNumber(number)}</span>
                </div>
                <div class="number-label">NÃšMERO SORTEADO</div>
            `;
        }
        
        function showAllNumbers(numbers) {
            currentDisplay.style.display = 'none';
            allNumbersDisplay.style.display = 'block';
            recentNumbers.style.display = 'none';
            
            allNumbersGrid.innerHTML = '';
            
            // Definir as colunas do BINGO
            const columns = [
                { letter: 'B', start: 1, end: 15, class: 'b' },
                { letter: 'I', start: 16, end: 30, class: 'i' },
                { letter: 'N', start: 31, end: 45, class: 'n' },
                { letter: 'G', start: 46, end: 60, class: 'g' },
                { letter: 'O', start: 61, end: 75, class: 'o' }
            ];
            
            // Criar cada coluna
            columns.forEach(column => {
                const columnDiv = document.createElement('div');
                columnDiv.className = 'bingo-column';
                
                // CabeÃ§alho da coluna
                const header = document.createElement('div');
                header.className = `column-header ${column.class}`;
                header.textContent = column.letter;
                columnDiv.appendChild(header);
                
                // Container dos nÃºmeros
                const numbersContainer = document.createElement('div');
                numbersContainer.className = 'column-numbers';
                
                // Adicionar nÃºmeros da coluna
                for (let i = column.start; i <= column.end; i++) {
                    const numberDiv = document.createElement('div');
                    numberDiv.className = 'number-cell';
                    numberDiv.textContent = formatNumber(i);
                    
                    if (numbers.includes(i)) {
                        numberDiv.classList.add('drawn');
                    }
                    
                    numbersContainer.appendChild(numberDiv);
                }
                
                columnDiv.appendChild(numbersContainer);
                allNumbersGrid.appendChild(columnDiv);
            });
        }
        
        function showWaitingMessage() {
            currentDisplay.style.display = 'flex';
            allNumbersDisplay.style.display = 'none';
            recentNumbers.style.display = 'none';
            
            currentDisplay.innerHTML = `
                <div class="waiting-message">
                    <h1>ðŸŽ¯ BINGO</h1>
                    <p>Aguardando prÃ³ximo nÃºmero...</p>
                </div>
            `;
        }
        
        function updateRecentNumbers(drawnNumbers) {
            if (!recentNumbersList) {
                return;
            }
            
            // Pegar os Ãºltimos 7 nÃºmeros em ordem de sorteio
            const recentNums = drawnNumbers.slice(-7);
            
            // Limpar lista atual
            recentNumbersList.innerHTML = '';
            
            if (recentNums.length === 0) {
                recentNumbers.style.display = 'none';
                return;
            }
            
            recentNumbers.style.display = 'block';
            
            // Criar elementos para cada nÃºmero
            recentNums.forEach((num, index) => {
                const numElement = document.createElement('div');
                numElement.className = 'recent-number';
                numElement.textContent = formatNumber(num);
                
                // Destacar o Ãºltimo nÃºmero sorteado
                if (index === recentNums.length - 1) {
                    numElement.classList.add('latest');
                }
                
                recentNumbersList.appendChild(numElement);
            });
        }
        
        // Modo fullscreen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F11' || (e.key === 'f' && e.ctrlKey)) {
                e.preventDefault();
                toggleFullscreen();
            }
        });
        
        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }
        
        // FunÃ§Ã£o para ativar/desativar NoSleep
        async function toggleWakeLock() {
            if (!wakeLockEnabled) {
                try {
                    await noSleep.enable();
                    wakeLockEnabled = true;
                    updateWakeLockButton();
                    showWakeLockStatus('ðŸ”’ Tela sempre ativa!');
                } catch (error) {
                    console.error('Erro ao ativar wake lock:', error);
                    showWakeLockStatus('âš ï¸ Erro ao manter tela ativa');
                }
            } else {
                noSleep.disable();
                wakeLockEnabled = false;
                updateWakeLockButton();
                showWakeLockStatus('ðŸ”“ Tela pode desligar');
            }
        }

        // Atualizar aparÃªncia do botÃ£o
        function updateWakeLockButton() {
            if (wakeLockBtn) {
                if (wakeLockEnabled) {
                    wakeLockBtn.textContent = 'ðŸ”“ Permitir Desligar';
                    wakeLockBtn.classList.add('active');
                } else {
                    wakeLockBtn.textContent = 'ðŸ”’ Manter Tela Ativa';
                    wakeLockBtn.classList.remove('active');
                }
            }
        }

        // FunÃ§Ã£o para ativar NoSleep automaticamente
        async function enableWakeLock() {
            if (!wakeLockEnabled) {
                await toggleWakeLock();
            }
        }

        // FunÃ§Ã£o para mostrar status do wake lock
        function showWakeLockStatus(message) {
            const statusDiv = document.createElement('div');
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px 20px;
                border-radius: 25px;
                font-size: 14px;
                z-index: 1000;
                backdrop-filter: blur(10px);
            `;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.remove();
            }, 3000);
        }

        // Event listener para o botÃ£o
        if (wakeLockBtn) {
            wakeLockBtn.addEventListener('click', toggleWakeLock);
        }

        // Ativar wake lock no primeiro toque/clique (exceto no botÃ£o)
        document.addEventListener('click', (e) => {
            if (e.target !== wakeLockBtn) {
                enableWakeLock();
            }
        }, { once: true });
        
        document.addEventListener('touchstart', (e) => {
            if (e.target !== wakeLockBtn) {
                enableWakeLock();
            }
        }, { once: true });
        
        // Mostrar/ocultar botÃ£o automaticamente
        function showWakeLockButton() {
            if (wakeLockControl) {
                wakeLockControl.style.opacity = '0.8';
                
                // Ocultar apÃ³s 5 segundos
                clearTimeout(hideButtonTimeout);
                hideButtonTimeout = setTimeout(() => {
                    if (wakeLockControl) {
                        wakeLockControl.style.opacity = '0.2';
                    }
                }, 5000);
            }
        }

        // Mostrar botÃ£o com movimento do mouse/toque
        document.addEventListener('mousemove', showWakeLockButton);
        document.addEventListener('touchstart', showWakeLockButton);
        
        // Carregar estado inicial
        async function loadInitialState() {
            try {
                const response = await fetch('/api/status');
                const state = await response.json();
                
                if (state.isShowingAll && state.drawnNumbers.length > 0) {
                    showAllNumbers(state.drawnNumbers.sort((a, b) => a - b));
                } else if (state.currentNumber) {
                    showCurrentNumber(state.currentNumber);
                    updateRecentNumbers(state.drawnNumbers);
                } else {
                    showWaitingMessage();
                }
                updateRecentNumbers(state.drawnNumbers);
            } catch (error) {
                console.error('Erro ao carregar estado inicial:', error);
            }
        }

        // Tentar ativar automaticamente apÃ³s carregar
        window.addEventListener('load', () => {
            setTimeout(enableWakeLock, 1000);
            showWakeLockButton();
            loadInitialState();
        });

        // Reativar wake lock se a visibilidade mudar
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && wakeLockEnabled) {
                setTimeout(enableWakeLock, 500);
            }
        });

        // Auto-refresh connection
        setInterval(() => {
            if (!socket.connected) {
                socket.connect();
            }
        }, 5000);
    </script>
</body>
</html>